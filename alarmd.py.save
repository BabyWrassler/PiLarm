#!/usr/bin/python

import subprocess
import datetime
import time
import os 
import RPi.GPIO as io
#import tweepy
import tweetpony

api = tweetpony.API(consumer_key = "abc", consumer_secret = "def", access_token = "ghi", access_token_secret = "jkl")
user = api.user
print "Hello, @%s!" % user.screen_name
text = raw_input("What would you like to tweet? ")


io.setmode(io.BCM)

pir_pin = 18
flashingLight_pin = 7

io.setup(pir_pin, io.IN)
io.setup(flashingLight_pin, io.OUT)
io.output(flashingLight_pin, io.LOW)

#def setup_api():
#  auth = tweepy.OAuthHandler('ijf5JCxlWLMFdQAAC6PLCQ',
#        'dAIRyTMNkXjeU09GM9z6OqXvoCnWuOqYWhZA5mrs')
#  auth.set_access_token('1480595341-KvFxkXATJXVvuJrqxp7RldWtHAkHUh9KmT7Hnfd',
#        '1XiknliCvHTwbSe2ZY41n8Cj0Qtejb3SXGzrqQdkV1Q')
#  return tweepy.API(auth)

def sendPicture():
	#print "Taking snapshot" 
	#import subprocess
	grab_cam = subprocess.Popen("sudo fswebcam -r 640x480 -d /dev/video0 -q /home/pi/Alarm/pictures/%m-%d-%y-%H%M.jpg", shell=True)
	grab_cam.wait()
	#print "Acquiring image file" 
	#import datetime 
	todays_date = datetime.datetime.today() 
	image_name = todays_date.strftime('%m-%d-%y-%H%M') 
	image_path = '/home/pi/Alarm/pictures/' + image_name + '.jpg'
	#print "Sending email"
	subprocess.Popen('echo "Here is your intruder:" | mail -a ' + image_path + ' -s "Intruder Alert" muddysdad@gmail.com', shell=True)
        #print "Tweeting image"
#        status = "Intruder alert: " + todays_date.strftime('%m-%d-%y-%H%M')
        api.status_update_with_media(image_path, status = ("Intruder alert: " + todays_date.strftime('%m-%d-%y-%H%M')))
	#print "Cleaning up"
	del_img = subprocess.Popen("sudo rm -rf  " + image_path, shell=True)
	del_img.wait()


# --------- Main Program ---------

#fo = open("/home/pi/Alarm/armed.txt", "r")
previous_pir=0

# Authorize Tweepy.
api = setup_api()

while True:
	current_pir=io.input(pir_pin)	
	#print "Previous PIR:" + str(previous_pir) + " Current PIR:" + str(current_pir)
	if previous_pir==0 and current_pir==1:
		with open("/home/pi/Alarm/armed.txt", "r") as fo:
                    fo.seek(0, 0)
                    status = fo.read(1)
                fo.closed
                print "Motion detected, armed status: " + str(status)
		if (status == "1"):
		    #subprocess.call('echo "Motion detected, please enter your passcode." | festival --tts', shell=True)
		    subprocess.call("mpg123 /home/pi/Alarm/motiondetect.mp3", shell=True)
                    #io.output(flashingLight_pin, io.HIGH)#remove
		    #subprocess.call("mpg123 /home/pi/Alarm/vo/0003.mp3", shell=True)
                    #io.output(flashingLight_pin, io.LOW)#remove
                    time.sleep(10)
		    with open("/home/pi/Alarm/armed.txt", "r") as fo:
                        fo.seek(0, 0)
                        status = fo.read(1)
                    fo.closed 
		    if (status == "1"):
		        print "Correct passcode not entered, emailing picture and sounding alarm."
                        grab_cam = subprocess.Popen("sudo fswebcam -r 640x480 -d /dev/video0 -q /home/pi/Alarm/pictures/%m-%d-%y-%H%M.jpg", shell=True)
                        grab_cam.wait()
                        todays_date = datetime.datetime.today()
                        image_name = todays_date.strftime('%m-%d-%y-%H%M')
                        image_path = '/home/pi/Alarm/pictures/' + image_name + '.jpg'
                        subprocess.Popen('echo "Here is your intruder:" | mail -a ' + image_path + ' -s "Intruder Alert" muddysdad@gmail.com', shell=True)
#                        api.status_update_with_media(image_path, status = ("Intruder alert: " + todays_date.strftime('%m-%d-%y-%H%M')))
#                        del_img = subprocess.Popen("sudo rm -rf  " + image_path, shell=True)
#                        del_img.wait()
                        
                        #sendPicture()
                        io.output(flashingLight_pin, io.HIGH)
		        subprocess.call("mpg123 /home/pi/Alarm/alarm.mp3", shell=True)
                        #time.sleep(5)
                        #subprocess.call('echo "Your intrusion has been recorded. Authorities have been notified." | festival --tts', shell=True)
                        subprocess.call("mpg123 /home/pi/Alarm/surrender.mp3", shell=True)
                        subprocess.call("mpg123 /home/pi/Alarm/alarm.mp3", shell=True)                       
                        io.output(flashingLight_pin, io.LOW)
                        del_img = subprocess.Popen("sudo rm -rf  " + image_path, shell=True)
                        del_img.wait()
	previous_pir=current_pir
	time.sleep(1)
